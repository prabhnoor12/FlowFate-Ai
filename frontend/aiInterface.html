<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlowFate AI Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="aiInterface.css">
</head>
<body>
  <div id="layout">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <nav>
        <ul>
          <li><a href="Dashboard.html">Dashboard</a></li>
          <li><a href="integrations.html">Integrations</a></li>
          <li><a href="Automations.html">Automations</a></li>
          <li><a href="Workflows.html">Workflows</a></li>
        </ul>
      </nav>
    </aside>
    <!-- Overlay for mobile -->
    <div id="sidebarOverlay"></div>
    <!-- Main Content -->
    <div id="mainContent">
      <!-- Header -->
      <header>
        <div class="branding">FlowFate AI</div>
        <div class="user-profile">
          <div class="user-profile-info">
            <div class="name" id="userName">User Name</div>
            <div class="last-seen">Last seen today at 3:45 PM</div>
          </div>
          <div id="userProfilePicWrapper">
            <img src="" alt="Profile Picture" class="user-profile-pic" id="userProfilePic" style="display:none;" />
            <div id="userInitial" class="user-profile-pic">?</div>
          </div>
        </div>
        <button id="menuIcon" style="background:none;border:none;box-shadow:none;padding:0;margin-left:1rem;display:none;">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 5.25h16.5m-16.5 6h16.5m-16.5 6h16.5" />
          </svg>
        </button>
      </header>
      <!-- Chat Section -->
      <main>
        <section id="chatBox">
          <div id="messagesContainer"></div>
        </section>
        <!-- Input Area -->
        <form id="messageForm" autocomplete="off">
          <input type="text" id="userInput" placeholder="Type your message..." required />
          <button type="submit">Send</button>
        </form>
      </main>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const menuIcon = document.getElementById('menuIcon');
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const userInitial = document.getElementById('userInitial');
      const userNameDiv = document.getElementById('userName');
      const userProfilePic = document.getElementById('userProfilePic');
      const userProfilePicWrapper = document.getElementById('userProfilePicWrapper');
      const BACKEND_BASE_URL = 'https://flowfate-ai.onrender.com';
      let token = localStorage.getItem('token');
      let userName = '';
      let userProfilePicUrl = '';
      async function fetchUserProfile() {
        if (!token) {
          // No token: show placeholder or do nothing (no redirect)
          if (userInitial) userInitial.textContent = '?';
          if (userNameDiv) userNameDiv.textContent = 'User Name';
          if (userProfilePic) userProfilePic.style.display = 'none';
          return;
        }
        try {
          const res = await fetch(`${BACKEND_BASE_URL}/api/users/me`, { headers: { 'Authorization': `Bearer ${token}` } });
          if (!res.ok) {
            localStorage.removeItem('token');
            if (userInitial) userInitial.textContent = '?';
            if (userNameDiv) userNameDiv.textContent = 'User Name';
            if (userProfilePic) userProfilePic.style.display = 'none';
            return;
          }
          const json = await res.json();
          userName = json.data?.name || '';
          userProfilePicUrl = json.data?.profilePic || '';
          if (userInitial) userInitial.textContent = userName ? userName.charAt(0).toUpperCase() : '?';
          if (userNameDiv) userNameDiv.textContent = userName || 'User Name';
          if (userProfilePic && userProfilePicUrl) {
            userProfilePic.src = userProfilePicUrl;
            userProfilePic.style.display = '';
            userInitial.style.display = 'none';
          } else if (userProfilePic) {
            userProfilePic.style.display = 'none';
            userInitial.textContent = userName ? userName.charAt(0).toUpperCase() : '?';
            userInitial.style.display = '';
          }
        } catch (e) {
          if (userInitial) userInitial.textContent = '?';
        }
      }
      await fetchUserProfile();
      if (userProfilePicWrapper) {
        userProfilePicWrapper.addEventListener('click', () => {
          window.location.href = 'userProfile.html';
        });
      }
      // Sidebar toggle for mobile
      if (menuIcon && sidebar && sidebarOverlay) {
        menuIcon.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          sidebar.classList.add('open');
          sidebarOverlay.style.display = 'block';
        });
        sidebarOverlay.addEventListener('click', (e) => {
          e.preventDefault();
          sidebar.classList.remove('open');
          sidebarOverlay.style.display = 'none';
        });
        // Prevent sidebar links from closing the sidebar unless on mobile
        sidebar.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', function(ev) {
            if (window.innerWidth <= 768) {
              sidebar.classList.remove('open');
              sidebarOverlay.style.display = 'none';
            }
          });
        });
      }
      // Hide sidebar on resize to desktop
      window.addEventListener('resize', () => {
        if (window.innerWidth >= 768) {
          sidebar.classList.remove('open');
          sidebarOverlay.style.display = 'none';
        } else {
          sidebar.classList.remove('open');
          sidebarOverlay.style.display = 'none';
        }
      });
      // Chat API connection
      const messageForm = document.getElementById('messageForm');
      const userInput = document.getElementById('userInput');
      const messagesContainer = document.getElementById('messagesContainer');
      function appendMessage(content, sender) {
        const message = document.createElement('div');
        message.className = `message ${sender}`;
        message.innerHTML = content;
        messagesContainer.appendChild(message);
        const chatBox = document.getElementById('chatBox');
        chatBox.scrollTop = chatBox.scrollHeight;
      }
      async function sendMessage(text) {
        if (!text.trim()) return '';
        try {
          const response = await fetch('https://flowfate-ai.onrender.com/api/openai', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            },
            body: JSON.stringify({ prompt: text })
          });
          if (!response.ok) {
            if (response.status === 401) {
              return '❌ You are not authorized. Please log in again.';
            }
            throw new Error('API error');
          }
          const data = await response.json();
          if (data.reply) return data.reply;
          if (data.data && data.data.reply) return data.data.reply;
          return '⚠️ No response from AI.';
        } catch (err) {
          return `❌ ${err.message}. Please try again later or check your connection.`;
        }
      }
      if (messageForm && userInput) {
        messageForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const text = userInput.value.trim();
          if (!text) return;
          appendMessage(text, 'user');
          userInput.value = '';
          // Show loading message and keep reference
          const loadingMsg = document.createElement('div');
          loadingMsg.className = 'message bot';
          loadingMsg.innerHTML = '<span style="color:#9ca3af;">...</span>';
          messagesContainer.appendChild(loadingMsg);
          const chatBox = document.getElementById('chatBox');
          chatBox.scrollTop = chatBox.scrollHeight;

          const reply = await sendMessage(text);
          loadingMsg.remove();
          appendMessage(reply, 'bot');
        });
      }
    });
  </script>
</body>
<footer class="auto-footer" style="text-align:center;color:#b0b8c1;font-size:0.95rem;padding:1.5rem 0 0.5rem 0;background:none;border-top:1px solid #e2e8f0;margin-top:2rem;">
  © 2025 FlowFate AI. All rights reserved. | <a href="help.html" style="color:#2563eb;text-decoration:underline;">Documentation</a>
</footer>
</html>