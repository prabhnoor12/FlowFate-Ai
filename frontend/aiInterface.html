
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlowFate AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex justify-center items-center min-h-screen p-4 overflow-hidden" role="main">

  <!-- Mobile-Responsive Chat UI -->
  <main class="w-full max-w-md bg-white rounded-3xl shadow-lg p-6 flex flex-col gap-4 h-[90vh]" aria-label="Chat interface">

    <!-- Header -->
    <header class="flex items-center gap-2" aria-label="Header">
      <div class="bg-gray-100 p-2 rounded-full">
        <img src="https://cdn-icons-png.flaticon.com/512/906/906349.png" class="h-6 w-6" alt="AI Icon" />
      </div>
      <span class="text-lg font-semibold" id="appTitle">FlowFate AI</span>
      <nav class="relative ml-auto" aria-label="User menu">
        <button id="profileBtn" aria-haspopup="true" aria-expanded="false" aria-controls="profileDropdown" class="bg-gray-200 text-xs w-8 h-8 rounded-full flex items-center justify-center font-medium focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:ring-offset-white transition-shadow" title="User Menu" tabindex="0">
          <span aria-label="User menu initial">M</span>
        </button>
        <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-36 bg-white rounded-xl shadow-lg border border-gray-100 z-20 py-2" role="menu" aria-labelledby="profileBtn">
          <a href="dashboard.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-t-xl focus:bg-gray-200 focus:outline-none" role="menuitem" tabindex="0">Dashboard</a>
          <button id="logoutBtn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-gray-100 rounded-b-xl focus:bg-red-200 focus:outline-none" role="menuitem" tabindex="0">Logout</button>
        </div>
      </nav>
    </header>



  <!-- Compact Icon Controls -->
  <nav class="flex justify-end gap-2 mb-1" aria-label="Chat controls">
    <button id="autoScrollToggle" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" title="Toggle Auto-Scroll" aria-pressed="true" tabindex="0">
      <svg id="autoScrollIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="#22c55e" id="autoScrollOnCircle" />
        <path d="M8 12l2 2 4-4" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" id="autoScrollOnCheck" />
      </svg>
      <span class="sr-only">Toggle Auto-Scroll</span>
    </button>
    <button id="clearChatBtn" class="p-2 rounded-full bg-red-100 hover:bg-red-200 text-red-600 transition-colors flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2" title="Clear Chat" tabindex="0">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
      <span class="sr-only">Clear Chat</span>
    </button>
  </nav>


    <!-- Chat Section: All controls and input are now inside the chat area -->
    <section class="relative flex-1 flex flex-col" aria-label="Chat messages">
      <div id="chatBgIcon" class="absolute left-0 right-0 top-4 flex justify-center pointer-events-none z-0 transition-opacity duration-700 opacity-40" aria-hidden="true">
        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 shadow" title="Chat Icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3C7.03 3 3 6.58 3 11.01c0 2.13 1.06 4.07 2.82 5.5-.13.98-.56 2.36-1.7 3.13 0 0-.03.02-.03.04 0 .09.07.16.16.16.02 0 .04 0 .06-.01 1.38-.18 2.44-.95 3.13-1.5.97.28 2.01.44 3.13.44 4.97 0 9-3.58 9-8.01S16.97 3 12 3z" />
          </svg>
        </span>
      </div>
      <div id="chatBox" class="flex flex-1 flex-col gap-4 mt-4 text-sm overflow-y-auto relative z-10 max-h-[60vh] w-full break-words" style="word-break:break-word;overflow-wrap:break-word;overflow-x:auto;" role="log" aria-live="polite" aria-relevant="additions">
        <div class="flex flex-col items-center justify-center mt-12 mb-2" id="emptyChatMsg" aria-label="Empty chat message">
          <p class="text-base">Start a new conversation</p>
          <p class="text-xs">How can FlowFate AI assist you today?</p>
        </div>
        <!-- Typing/Loading Indicator -->
        <div id="typingIndicator" class="text-center text-xs text-gray-500 mt-2 hidden flex-col items-center justify-center" role="status" aria-live="polite">
          <span class="inline-flex items-center gap-2 justify-center">
            <svg class="animate-spin h-4 w-4 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
            </svg>
            FlowFate AI is typing...
          </span>
        </div>
      </div>

      <!-- Help Icon and Notion Quick Actions now inside chat area, below chatBox -->
      <nav class="flex justify-end mb-1 mt-2" aria-label="Quick actions and help">
        <!-- Notion Quick Actions -->
        <div class="flex gap-2 mb-2" role="group" aria-label="Notion quick actions">
          <button id="createNotionPageBtn" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-black hover:bg-green-100 transition-colors focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2" title="Create Notion Page" aria-label="Create Notion Page" tabindex="0">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <rect x="4" y="4" width="16" height="16" rx="3" stroke="currentColor" stroke-width="1.5" fill="#fff" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v8m-4-4h8" stroke="#22c55e" stroke-width="1.5" />
            </svg>
            <span class="sr-only">Create Notion Page</span>
          </button>
          <button id="showNotionFeedBtn" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-indigo-600 hover:bg-indigo-200 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2" title="Show Recent Notion Updates" aria-label="Show Recent Notion Updates" tabindex="0">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <rect x="4" y="4" width="16" height="16" rx="3" stroke="currentColor" stroke-width="1.5" fill="#fff" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 8h8M8 12h8M8 16h4" stroke="#6366f1" stroke-width="1.5" />
            </svg>
            <span class="sr-only">Show Notion Feed</span>
          </button>
        </div>
        <a href="help.html" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-blue-500 hover:bg-blue-100 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" title="Help" aria-label="Help" tabindex="0">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M12 14.25V12a2.25 2.25 0 10-2.25-2.25" />
            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.5" />
          </svg>
          <span class="sr-only">Help</span>
        </a>
      </nav>

      <!-- Input Section with File Upload Icon now inside chat area -->
      <form class="mt-2" role="search" aria-label="Chat input" onsubmit="event.preventDefault();handleUserInput();">
        <div class="flex items-center border rounded-xl overflow-hidden">
          <input type="text" placeholder="Reply to FlowFate AI" class="flex-1 px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-400" id="userInput" aria-label="Chat input" autocomplete="off" required />
          <label for="fileInput" class="cursor-pointer px-2 flex items-center h-full" title="Attach file" aria-label="Attach file" tabindex="0">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-500 hover:text-blue-500 transition-colors">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-3A2.25 2.25 0 008.25 5.25V19.5a3.75 3.75 0 007.5 0V7.5a.75.75 0 00-1.5 0v12a2.25 2.25 0 11-4.5 0V5.25" />
            </svg>
            <span class="sr-only">Attach file</span>
          </label>
          <input type="file" id="fileInput" class="hidden" title="Choose a file to upload" aria-label="File upload" tabindex="0" />
          <button type="submit" class="px-4 text-blue-500 font-semibold focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" aria-label="Send message" tabindex="0">➤</button>
        </div>
      </form>
    </section>
  </main>

  <script>
    // --- Notion API Functions ---
    function notionCreatePage() {
      appendMessage('Creating a new Notion page...', 'system');
      fetch('https://flowfate-ai.onrender.com/api/notion/create-page', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      })
        .then(response => {
          if (!response.ok) throw new Error('API error');
          return response.json();
        })
        .then(data => {
          if (data && data.url) {
            appendMessage(`✅ Notion page created: <a href="${data.url}" target="_blank" class="text-blue-500 underline">Open Page</a>`, 'system');
          } else {
            appendMessage('⚠️ Notion page created, but no URL returned.', 'system');
          }
        })
        .catch(() => appendMessage('❌ Failed to create Notion page.', 'system'));
    }

    function notionQueryDatabase(queryText) {
      appendMessage('Querying Notion database...', 'system');
      fetch('https://flowfate-ai.onrender.com/api/notion/query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: queryText })
      })
        .then(response => {
          if (!response.ok) throw new Error('API error');
          return response.json();
        })
        .then(data => {
          if (data && data.results && data.results.length > 0) {
            let html = '<ul class="list-disc ml-6">';
            data.results.forEach(item => {
              html += `<li>${item}</li>`;
            });
            html += '</ul>';
            appendMessage(html, 'system');
          } else {
            appendMessage('No results found in Notion database.', 'system');
          }
        })
        .catch(() => appendMessage('❌ Failed to query Notion database.', 'system'));
    }

    function notionCreateTaskOrReminder(text) {
      appendMessage('Creating Notion task/reminder...', 'system');
      fetch('https://flowfate-ai.onrender.com/api/notion/create-task', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      })
        .then(response => {
          if (!response.ok) throw new Error('API error');
          return response.json();
        })
        .then(data => {
          if (data && data.url) {
            appendMessage(`✅ Notion task/reminder created: <a href="${data.url}" target="_blank" class="text-blue-500 underline">Open Task</a>`, 'system');
          } else {
            appendMessage('⚠️ Notion task/reminder created, but no URL returned.', 'system');
          }
        })
        .catch(() => appendMessage('❌ Failed to create Notion task/reminder.', 'system'));
    }

    function notionShowRecentFeed() {
      appendMessage('Fetching recent Notion updates...', 'system');
      fetch('https://flowfate-ai.onrender.com/api/notion/recent', {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      })
        .then(response => {
          if (!response.ok) throw new Error('API error');
          return response.json();
        })
        .then(data => {
          if (data && data.updates && data.updates.length > 0) {
            let html = '<div class="text-left"><b>Recent Notion Updates:</b><ul class="list-disc ml-6">';
            data.updates.forEach(item => {
              html += `<li><a href="${item.url}" target="_blank" class="text-blue-500 underline">${item.title || 'Untitled'}</a> <span class="text-xs text-gray-400">${item.time || ''}</span></li>`;
            });
            html += '</ul></div>';
            appendMessage(html, 'system');
          } else {
            appendMessage('No recent Notion updates found.', 'system');
          }
        })
        .catch(() => appendMessage('❌ Failed to fetch Notion updates.', 'system'));
    }

    function notionUnfurlLinks(msgDiv) {
      const notionUrlRegex = /https?:\/\/(www\.)?notion\.so\/[\w\-?=&#%]+/g;
      const links = msgDiv.innerHTML.match(notionUrlRegex);
      if (links) {
        links.forEach(url => {
          fetch('https://flowfate-ai.onrender.com/api/notion/unfurl', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
          })
            .then(response => {
              if (!response.ok) return;
              return response.json();
            })
            .then(data => {
              if (data && data.title) {
                const preview = document.createElement('div');
                preview.className = 'bg-gray-50 border border-gray-200 rounded p-2 mt-1 text-xs text-left';
                preview.innerHTML = `<b>${data.title}</b><br>${data.snippet || ''}`;
                const linkEls = msgDiv.querySelectorAll('a');
                linkEls.forEach(a => {
                  if (a.href.startsWith(url)) {
                    a.parentNode.insertBefore(preview, a.nextSibling);
                  }
                });
              }
            })
            .catch(() => {});
        });
      }
    }

    // --- Chat UI and Utility Functions ---
    function saveChatHistory() {
      const chatBox = document.getElementById('chatBox');
      const messages = Array.from(chatBox.querySelectorAll('.message')).map(msg => ({
        html: msg.outerHTML
      }));
      localStorage.setItem('flowfate_chat_history', JSON.stringify(messages));
    }

    function loadChatHistory() {
      const chatBox = document.getElementById('chatBox');
      const history = localStorage.getItem('flowfate_chat_history');
      if (history) {
        chatBox.innerHTML = '';
        const messages = JSON.parse(history);
        messages.forEach(m => {
          const temp = document.createElement('div');
          temp.innerHTML = m.html;
          chatBox.appendChild(temp.firstChild);
        });
      }
    }

    function showTypingIndicator(show) {
      const typing = document.getElementById('typingIndicator');
      if (typing) typing.classList.toggle('hidden', !show);
    }

    function updateChatBgIconVisibility() {
      const chatBox = document.getElementById('chatBox');
      const chatBgIcon = document.getElementById('chatBgIcon');
      const emptyChatMsg = document.getElementById('emptyChatMsg');
      if (!chatBox || !chatBgIcon || !emptyChatMsg) return;
      if (chatBox.children.length === 1 && chatBox.contains(emptyChatMsg)) {
        chatBgIcon.style.opacity = '0.4';
        chatBgIcon.style.pointerEvents = 'none';
      } else {
        chatBgIcon.style.opacity = '0';
        chatBgIcon.style.pointerEvents = 'none';
      }
    }

    function appendMessage(text, sender = 'user') {
      const chatBox = document.getElementById('chatBox');
      const emptyChatMsg = document.getElementById('emptyChatMsg');
      if (emptyChatMsg && emptyChatMsg.parentNode === chatBox) {
        chatBox.removeChild(emptyChatMsg);
      }
      const msg = document.createElement('div');
      let bgClass = '';
      let alignClass = '';
      if (sender === 'user') {
        bgClass = 'bg-green-100 text-gray-900';
        alignClass = 'self-end';
      } else if (sender === 'bot') {
        bgClass = 'bg-white text-gray-900 border border-gray-200';
        alignClass = 'self-start';
      } else if (sender === 'system') {
        bgClass = 'bg-yellow-50 text-yellow-800 border border-yellow-200';
        alignClass = 'self-center';
      }
      msg.className = `${alignClass} message ${sender} ${bgClass} text-sm p-2 my-1 rounded-xl max-w-xs shadow break-words`;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      let displayText = text;
      // If bot, sanitize markdown links and strip tags for user-friendly output
      if (sender === 'bot') {
        // Special case: If the message is exactly the Notion connect prompt, render a styled block
        if (
          text &&
          text.trim().startsWith('✅ Final Display to User') &&
          text.includes('Connect Notion to FlowFate')
        ) {
          displayText = `
            <div class="flex flex-col items-start gap-2 p-3 bg-blue-50 border border-blue-200 rounded-xl">
              <span class="text-2xl">🔗</span>
              <div class="font-semibold text-blue-900">Connect Notion to FlowFate!</div>
              <div class="text-sm text-blue-800">To unlock powerful Notion automations, <a href='dashboard.html' class='text-blue-600 underline font-medium' target='_blank'>click here to connect your Notion account</a>. Once connected, you can sync content, trigger workflows, and more—right from FlowFate!</div>
            </div>
          `;
        } else {
          // Convert markdown links [text](url) to HTML links
          displayText = displayText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, label, url) {
            // Only show the label as a clickable link, not the markdown
            return `<a href="${url}" target="_blank" class="text-blue-500 underline">${label}</a>`;
          });
          // Remove any remaining HTML tags except <a>
          displayText = displayText.replace(/<(?!a\b)[^>]*>/gi, '');
        }
      }
      msg.innerHTML = `<div>${displayText}</div><div class="text-xs text-right opacity-60">${time}</div>`;
      chatBox.appendChild(msg);
      if (sender === 'user' || sender === 'bot') {
        setTimeout(() => notionUnfurlLinks(msg), 0);
      }
      // Always scroll to bottom after new message
      setTimeout(scrollChatToBottom, 0);
      saveChatHistory();
      updateChatBgIconVisibility();
    }

    function scrollChatToBottom() {
      const chatBox = document.getElementById('chatBox');
      if (chatBox) {
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    // --- Event Handlers ---
    function handleUserInput() {
      const input = document.getElementById('userInput');
      const value = input.value.trim();
      if (value !== "") {
        if (value.toLowerCase().startsWith('/notion-query')) {
          const queryText = value.replace('/notion-query', '').trim();
          if (queryText) {
            notionQueryDatabase(queryText);
          } else {
            appendMessage('Please provide a query after /notion-query', 'system');
          }
        } else if (value.toLowerCase().startsWith('/notion-feed')) {
          notionShowRecentFeed();
        } else if (value.toLowerCase().startsWith('/notion-task')) {
          const taskText = value.replace('/notion-task', '').trim();
          if (taskText) {
            notionCreateTaskOrReminder(taskText);
          } else {
            appendMessage('Please provide a task/reminder after /notion-task', 'system');
          }
        } else if (value.toLowerCase().startsWith('/remind')) {
          const taskText = value.replace('/remind', '').trim();
          if (taskText) {
            notionCreateTaskOrReminder(taskText);
          } else {
            appendMessage('Please provide a reminder after /remind', 'system');
          }
        } else {
          sendMessage(value);
        }
        input.value = "";
      }
    }

    function handleFileInputChange() {
      const fileInput = document.getElementById('fileInput');
      if (!fileInput) return;
      try {
        const chatBox = document.getElementById('chatBox');
        const emptyChatMsg = document.getElementById('emptyChatMsg');
        const file = fileInput.files && fileInput.files[0];
        if (file && chatBox) {
          if (emptyChatMsg && emptyChatMsg.parentNode === chatBox) {
            chatBox.removeChild(emptyChatMsg);
          }
          const fileMessage = document.createElement('div');
          fileMessage.className = 'self-end message file bg-blue-100 p-2 rounded my-2 max-w-xs';
          fileMessage.innerHTML = `📎 <strong>${file.name}</strong> (${Math.round(file.size / 1024)} KB)`;
          chatBox.appendChild(fileMessage);
          scrollChatToBottom();
        }
      } catch (e) {}
    }

    function handleAutoScrollToggle() {
      const autoScrollOnCircle = document.getElementById('autoScrollOnCircle');
      const autoScrollOnCheck = document.getElementById('autoScrollOnCheck');
      window.autoScrollEnabled = !window.autoScrollEnabled;
      if (window.autoScrollEnabled) {
        autoScrollOnCircle.setAttribute('fill', '#22c55e');
        autoScrollOnCheck.setAttribute('stroke', '#fff');
      } else {
        autoScrollOnCircle.setAttribute('fill', '#ef4444');
        autoScrollOnCheck.setAttribute('stroke', '#fff');
      }
    }

    function handleClearChat() {
      const chatBox = document.getElementById('chatBox');
      const emptyChatMsg = document.getElementById('emptyChatMsg');
      if (chatBox) {
        chatBox.innerHTML = '';
        if (emptyChatMsg) {
          chatBox.appendChild(emptyChatMsg);
        }
        updateChatBgIconVisibility();
      }
    }

    // --- Profile Dropdown ---
    function setupProfileDropdown() {
      const profileBtn = document.getElementById('profileBtn');
      const profileDropdown = document.getElementById('profileDropdown');
      let dropdownOpen = false;
      if (profileBtn && profileDropdown) {
        profileBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          dropdownOpen = !dropdownOpen;
          profileDropdown.classList.toggle('hidden', !dropdownOpen);
          profileBtn.setAttribute('aria-expanded', dropdownOpen);
        });
        document.addEventListener('click', (e) => {
          if (dropdownOpen && !profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
            profileDropdown.classList.add('hidden');
            dropdownOpen = false;
            profileBtn.setAttribute('aria-expanded', 'false');
          }
        });
      }
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          window.location.href = 'login.html';
        });
      }
    }

    // --- Chat Send ---
    async function sendMessage(text) {
      appendMessage(text, 'user');
      showTypingIndicator(true);
      try {
        const response = await fetch('https://flowfate-ai.onrender.com/api/openai', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ prompt: text })
        });
        if (!response.ok) {
          throw new Error('API error');
        }
        const data = await response.json();
        let reply = null;
        if (data && data.reply) {
          reply = data.reply;
        } else if (data && data.data && data.data.reply) {
          reply = data.data.reply;
        } else if (Array.isArray(data)) {
          for (let i = data.length - 1; i >= 0; i--) {
            const item = data[i];
            if (item.type === 'message' && item.role === 'assistant' && item.content && Array.isArray(item.content)) {
              for (const c of item.content) {
                if (c.type === 'output_text' && c.text) {
                  reply = c.text;
                  break;
                }
              }
              if (reply) break;
            }
          }
        }
        if (reply) {
          appendMessage(reply, 'bot');
        } else {
          appendMessage('⚠️ No response from AI.', 'system');
        }
      } catch (err) {
        appendMessage('❌ Failed to get response from AI.', 'system');
      } finally {
        showTypingIndicator(false);
      }
    }

    // --- Initialization ---
    function setupEventListeners() {
      const createNotionPageBtn = document.getElementById('createNotionPageBtn');
      if (createNotionPageBtn) {
        createNotionPageBtn.addEventListener('click', notionCreatePage);
      }
      const showNotionFeedBtn = document.getElementById('showNotionFeedBtn');
      if (showNotionFeedBtn) {
        showNotionFeedBtn.addEventListener('click', notionShowRecentFeed);
      }
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.addEventListener('change', handleFileInputChange);
      }
      const autoScrollToggle = document.getElementById('autoScrollToggle');
      if (autoScrollToggle) {
        autoScrollToggle.addEventListener('click', handleAutoScrollToggle);
      }
      const clearChatBtn = document.getElementById('clearChatBtn');
      if (clearChatBtn) {
        clearChatBtn.addEventListener('click', handleClearChat);
      }
      const userInput = document.getElementById('userInput');
      if (userInput) {
        userInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleUserInput();
          }
        });
      }
    }

    window.autoScrollEnabled = true;

    window.addEventListener('DOMContentLoaded', () => {
      try {
        setupProfileDropdown();
        setupEventListeners();
        loadChatHistory();
        updateChatBgIconVisibility();
      } catch (e) {}
    });
  </script>

</body>
</html>


