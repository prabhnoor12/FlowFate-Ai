<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Workflow Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Custom styles for sidebar transition */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-open {
            transform: translateX(0);
        }
        .sidebar-closed {
            transform: translateX(-100%);
        }
        @media (min-width: 768px) {
            .sidebar-closed {
                transform: translateX(0); /* Sidebar always visible on larger screens */
            }
        }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
        }
        .modal.open {
            display: flex; /* Display when open */
        }
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem; /* rounded-md */
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .notification.show {
            opacity: 1;
        }
        .notification.success {
            background-color: #48bb78; /* bg-green-500 */
        }
        .notification.error {
            background-color: #ef4444; /* bg-red-500 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal h-screen flex flex-col md:flex-row">

    <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 bg-gray-800 text-white w-64 p-5 z-40 md:relative md:translate-x-0 sidebar-closed">
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-2xl font-bold">My Workflow</h1>
            <button id="closeSidebar" class="text-white md:hidden focus:outline-none">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <nav>
            <ul>
                <li class="mb-4">
                    <a href="#" class="block py-2 px-4 rounded hover:bg-gray-700 transition duration-200">
                        <svg class="inline-block h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l7 7m-11 2v5a1 1 0 001 1h3"></path>
                        </svg>
                        Dashboard
                    </a>
                </li>
                <li class="mb-4">
                    <a href="#" class="block py-2 px-4 rounded hover:bg-gray-700 transition duration-200">
                        <svg class="inline-block h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v2m-3-12v5m-3-3h3M3 8v8a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 1 0 00-2 2z"></path>
                        </svg>
                        Automation
                    </a>
                </li>
                <li class="mb-4">
                    <a href="#" class="block py-2 px-4 rounded hover:bg-gray-700 transition duration-200">
                        <svg class="inline-block h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4m-4 4l-4 4"></path>
                        </svg>
                        Integration
                    </a>
                </li>
                <li class="mb-4">
                    <a href="#" class="block py-2 px-4 rounded hover:bg-gray-700 transition duration-200">
                        <svg class="inline-block h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v13m-3-8h6m-12 0h-2M4 8h2"></path>
                        </svg>
                        AI Interface
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow p-4 flex justify-between items-center md:hidden">
            <button id="openSidebar" class="text-gray-600 focus:outline-none">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-200 p-6">
            <h2 class="text-3xl font-semibold text-gray-800 mb-6">Welcome to your Workflow! ðŸ‘‹</h2>

            <div id="workflowCardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div id="addStepCard" class="bg-white rounded-lg shadow-md p-6 border-dashed border-2 border-gray-400 text-gray-600 flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 hover:text-blue-500 transition-all duration-300">
                    <svg class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <h3 class="text-xl font-semibold">Add New Step</h3>
                    <p class="text-center text-sm">Click to create another workflow step.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="notificationContainer"></div>

    <script>
        // --- Global State & Utility Functions ---
        let workflowSteps = []; // Array to hold all workflow step data
        let currentEditingStepId = null; // To track which step's data is being edited in the modal

        // Utility to show notifications
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);

            // Trigger reflow to ensure transition works
            notification.offsetWidth;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove(), { once: true });
            }, 3000); // Notification disappears after 3 seconds
        }

        // --- Data Persistence (LocalStorage) ---
        function saveSteps() {
            try {
                localStorage.setItem('workflowSteps', JSON.stringify(workflowSteps));
                showNotification('Workflow saved!', 'success');
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                showNotification('Failed to save workflow!', 'error');
            }
        }

        function loadSteps() {
            try {
                const savedSteps = localStorage.getItem('workflowSteps');
                if (savedSteps) {
                    workflowSteps = JSON.parse(savedSteps);
                } else {
                    // Initialize with default steps if no saved data
                    workflowSteps = [
                        { id: 1, title: 'Initial Setup', integration: 'User Accounts', description: 'Configure your basic profile and security settings for the system.' },
                        { id: 2, title: 'Data Import', integration: 'CRM, ERP', description: 'Connect your primary data sources and import initial datasets for processing.' }
                    ];
                }
            } catch (e) {
                console.error("Error loading from localStorage:", e);
                showNotification('Failed to load workflow data!', 'error');
                workflowSteps = []; // Reset to empty if corrupted
            }
        }

        // --- DOM Manipulation & Rendering ---
        const workflowCardsContainer = document.getElementById('workflowCardsContainer');
        const addStepCard = document.getElementById('addStepCard');
        const body = document.body; // Reference to the body for appending modals

        // Function to open a modal
        function openModal(stepId) {
            currentEditingStepId = stepId;
            const modal = document.getElementById(`modal${stepId}`);
            if (modal) {
                const stepData = workflowSteps.find(step => step.id === stepId);
                if (stepData) {
                    // Populate modal form fields with current step data
                    const form = modal.querySelector('.modal-form');
                    form.elements.title.value = stepData.title || '';
                    form.elements.integration.value = stepData.integration || '';
                    form.elements.description.value = stepData.description || '';
                    modal.classList.add('open');
                } else {
                    showNotification('Step data not found!', 'error');
                }
            } else {
                showNotification('Modal not found!', 'error');
            }
        }

        // Function to close a modal
        function closeModal(stepId) {
            const modal = document.getElementById(`modal${stepId}`);
            if (modal) {
                modal.classList.remove('open');
                currentEditingStepId = null; // Clear tracking
            }
        }

        // Centralized event listener for modal interactions (closes, saves, deletes)
        document.addEventListener('click', (event) => {
            // Close modal button
            if (event.target.classList.contains('close-modal')) {
                const modal = event.target.closest('.modal');
                if (modal) {
                    const stepId = parseInt(modal.id.replace('modal', ''));
                    closeModal(stepId);
                }
            }
            // Clicking on the modal overlay itself
            else if (event.target.classList.contains('modal') && event.target.classList.contains('open')) {
                const stepId = parseInt(event.target.id.replace('modal', ''));
                closeModal(stepId);
            }
            // Delete Step button on card
            else if (event.target.classList.contains('delete-step-btn')) {
                const stepId = parseInt(event.target.dataset.stepId);
                deleteStep(stepId);
            }
            // Delete Step button inside modal
            else if (event.target.classList.contains('delete-step-btn-modal')) {
                const stepId = parseInt(event.target.dataset.stepId);
                if (confirm('Are you sure you want to delete this step?')) {
                     deleteStep(stepId);
                }
            }
            // Define Step button on card
            else if (event.target.tagName === 'BUTTON' && event.target.textContent === 'Define Step') {
                const card = event.target.closest('.bg-white');
                const stepId = parseInt(card.id.replace('card', ''));
                openModal(stepId);
            }
        });

        // Handle form submission (Save button inside modal)
        document.addEventListener('submit', (event) => {
            if (event.target.classList.contains('modal-form')) {
                event.preventDefault(); // Prevent default form submission
                const form = event.target;
                const stepId = parseInt(form.dataset.stepId);
                saveModalData(stepId, form);
            }
        });


        /**
         * Renders all workflow steps from the workflowSteps array into the DOM.
         * This function should be called whenever workflowSteps array is modified.
         */
        function renderAllSteps() {
            // Remove all existing dynamic cards and modals
            const existingCards = workflowCardsContainer.querySelectorAll('.bg-white:not(#addStepCard)');
            existingCards.forEach(card => card.remove());

            document.querySelectorAll('.modal:not(#modal1):not(#modal2)').forEach(modal => modal.remove()); // Remove dynamic modals

            // Sort steps by ID to maintain logical order
            workflowSteps.sort((a, b) => a.id - b.id);

            workflowSteps.forEach(step => {
                // Create Card Element
                const card = document.createElement('div');
                card.id = `card${step.id}`;
                // Use a different color for dynamic steps for visual distinction, or apply based on step type later
                const cardBgColor = (step.id === 1 || step.id === 2) ? 'bg-blue-500' : 'bg-purple-500';
                const buttonBgColor = (step.id === 1) ? 'bg-blue-500' : (step.id === 2 ? 'bg-green-500' : 'bg-purple-500');

                card.className = `bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-shadow duration-300`;
                card.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Step ${step.id}: ${step.title || 'Untitled'}</h3>
                    <p class="text-gray-600">${step.description ? (step.description.length > 100 ? step.description.substring(0, 100) + '...' : step.description) : 'Click to define details.'}</p>
                    <button class="mt-4 ${buttonBgColor} hover:opacity-90 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-${buttonBgColor.split('-')[1]}-500 focus:ring-opacity-50">Define Step</button>
                    <button data-step-id="${step.id}" class="delete-step-btn ml-2 mt-4 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">Delete</button>
                `;
                workflowCardsContainer.insertBefore(card, addStepCard); // Insert before the 'Add New Step' card

                // Create Modal Element
                const modal = document.createElement('div');
                modal.id = `modal${step.id}`;
                modal.className = 'modal fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">Step ${step.id} Details</h3>
                            <button class="close-modal text-gray-500 hover:text-gray-700 focus:outline-none">
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <form data-step-id="${step.id}" class="modal-form">
                            <div class="mb-4">
                                <label for="title${step.id}" class="block text-gray-700 text-sm font-bold mb-2">Title <span class="text-red-500">*</span></label>
                                <input type="text" id="title${step.id}" name="title" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., Data Validation" value="${step.title || ''}" required>
                            </div>
                            <div class="mb-4">
                                <label for="integration${step.id}" class="block text-gray-700 text-sm font-bold mb-2">Integration</label>
                                <input type="text" id="integration${step.id}" name="integration" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., Custom Script, Azure Functions" value="${step.integration || ''}">
                            </div>
                            <div class="mb-6">
                                <label for="description${step.id}" class="block text-gray-700 text-sm font-bold mb-2">Description <span class="text-red-500">*</span></label>
                                <textarea id="description${step.id}" name="description" rows="5" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Provide a detailed description of this workflow step." required>${step.description || ''}</textarea>
                            </div>
                            <div class="flex justify-end mt-4">
                                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2">Save</button>
                                <button type="button" class="delete-step-btn-modal bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2" data-step-id="${step.id}">Delete Step</button>
                                <button type="button" class="close-modal bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Close</button>
                            </div>
                        </form>
                    </div>
                `;
                body.appendChild(modal); // Append modal to the body
            });
        }

        /**
         * Saves data from the modal form into the workflowSteps array.
         * @param {number} stepId - The ID of the step being saved.
         * @param {HTMLFormElement} form - The form element containing the input data.
         */
        function saveModalData(stepId, form) {
            const title = form.elements.title.value.trim();
            const integration = form.elements.integration.value.trim();
            const description = form.elements.description.value.trim();

            if (!title || !description) {
                showNotification('Title and Description are required!', 'error');
                return; // Stop if validation fails
            }

            const stepIndex = workflowSteps.findIndex(step => step.id === stepId);
            if (stepIndex !== -1) {
                workflowSteps[stepIndex] = {
                    ...workflowSteps[stepIndex], // Keep existing properties
                    title: title,
                    integration: integration,
                    description: description
                };
                saveSteps(); // Save to localStorage
                renderAllSteps(); // Re-render the UI to reflect changes
                closeModal(stepId); // Close the modal
            } else {
                showNotification('Error: Step not found for saving.', 'error');
            }
        }

        /**
         * Creates a new workflow step and adds it to the workflowSteps array.
         */
        function createNewStep() {
            // Find the maximum existing ID and increment for the new one
            const maxId = workflowSteps.length > 0 ? Math.max(...workflowSteps.map(step => step.id)) : 0;
            const newStepId = maxId + 1;

            const newStepData = {
                id: newStepId,
                title: '', // Start with empty values
                integration: '',
                description: ''
            };

            workflowSteps.push(newStepData);
            saveSteps(); // Save the updated array
            renderAllSteps(); // Re-render the UI with the new step
            openModal(newStepId); // Open the modal for the newly created step
        }

        /**
         * Deletes a workflow step from the workflowSteps array and the DOM.
         * @param {number} stepId - The ID of the step to delete.
         */
        function deleteStep(stepId) {
            const initialCount = workflowSteps.length;
            workflowSteps = workflowSteps.filter(step => step.id !== stepId);

            if (workflowSteps.length < initialCount) {
                // Also remove its modal if open or present
                const modalToRemove = document.getElementById(`modal${stepId}`);
                if (modalToRemove) {
                    modalToRemove.remove();
                }
                saveSteps(); // Save the updated array
                renderAllSteps(); // Re-render to update step numbers/order
                showNotification(`Step ${stepId} deleted.`, 'success');
            } else {
                showNotification('Error: Step not found for deletion.', 'error');
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSteps(); // Load steps from localStorage
            renderAllSteps(); // Render the initial UI based on loaded data

            // Add event listener to the "Add New Step" card
            addStepCard.addEventListener('click', createNewStep);

            // Sidebar toggling (retained)
            const sidebar = document.getElementById('sidebar');
            const openSidebarBtn = document.getElementById('openSidebar');
            const closeSidebarBtn = document.getElementById('closeSidebar');

            openSidebarBtn.addEventListener('click', () => {
                sidebar.classList.remove('sidebar-closed');
                sidebar.classList.add('sidebar-open');
            });
            closeSidebarBtn.addEventListener('click', () => {
                sidebar.classList.remove('sidebar-open');
                sidebar.classList.add('sidebar-closed');
            });

            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    sidebar.classList.remove('sidebar-closed', 'sidebar-open');
                } else {
                    sidebar.classList.add('sidebar-closed');
                }
            });
        });
    </script>
</body>
</html>
