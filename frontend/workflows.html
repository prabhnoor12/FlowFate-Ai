<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Workflow Dashboard (Backend Integrated)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Custom styles for sidebar transition */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-open {
            transform: translateX(0);
        }
        .sidebar-closed {
            transform: translateX(-100%);
        }
        @media (min-width: 768px) {
            .sidebar-closed {
                transform: translateX(0); /* Sidebar always visible on larger screens */
            }
        }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
        }
        .modal.open {
            display: flex; /* Display when open */
        }
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem; /* rounded-md */
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .notification.show {
            opacity: 1;
        }
        .notification.success {
            background-color: #48bb78; /* bg-green-500 */
        }
        .notification.error {
            background-color: #ef4444; /* bg-red-500 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal h-screen flex flex-col md:flex-row">

    <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 bg-gray-800 text-white w-64 p-5 z-40 md:relative md:translate-x-0 sidebar-closed">
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-2xl font-bold">My Workflow</h1>
            <button id="closeSidebar" class="text-white md:hidden focus:outline-none">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <nav>
            <ul>
                <li class="mb-4">
                    <a href="#" class="block py-2 px-4 rounded hover:bg-gray-700 transition duration-200">
                        <svg class="inline-block h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l7 7m-11 2v5a1 1 0 001 1h3"></path>
                        </svg>
                        Dashboard
                    </a>
                </li>
                <li class="mb-4">
                    <a href="#" class="block py-2 px-4 rounded hover:bg-gray-700 transition duration-200">
                        <svg class="inline-block h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v2m-3-12v5m-3-3h3M3 8v8a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 1 0 00-2 2z"></path>
                        </svg>
                        Automation
                    </a>
                </li>
                <li class="mb-4">
                    <a href="#" class="block py-2 px-4 rounded hover:bg-gray-700 transition duration-200">
                        <svg class="inline-block h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4m-4 4l-4 4"></path>
                        </svg>
                        Integration
                    </a>
                </li>
                <li class="mb-4">
                    <a href="#" class="block py-2 px-4 rounded hover:bg-gray-700 transition duration-200">
                        <svg class="inline-block h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v13m-3-8h6m-12 0h-2M4 8h2"></path>
                        </svg>
                        AI Interface
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow p-4 flex justify-between items-center md:hidden">
            <button id="openSidebar" class="text-gray-600 focus:outline-none">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-200 p-6">
            <h2 class="text-3xl font-semibold text-gray-800 mb-6">Welcome to your Workflow! ðŸ‘‹</h2>

            <div id="workflowCardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div id="addStepCard" class="bg-white rounded-lg shadow-md p-6 border-dashed border-2 border-gray-400 text-gray-600 flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 hover:text-blue-500 transition-all duration-300">
                    <svg class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <h3 class="text-xl font-semibold">Add New Step</h3>
                    <p class="text-center text-sm">Click to create another workflow step.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="notificationContainer"></div>

    <script>
        // --- Global State & Utility Functions ---
        let workflowSteps = []; // Local cache of workflow step data
        let currentEditingStepId = null; // To track which step's data is being edited in the modal

        // Base URL for your backend API
        // IMPORTANT: Replace with your actual backend API URL if it's not relative to your frontend.
        const API_BASE_URL = '/api/workflows'; 

        // Utility to show notifications
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);

            // Trigger reflow to ensure transition works
            notification.offsetWidth;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove(), { once: true });
            }, 3000); // Notification disappears after 3 seconds
        }

        // --- Backend API Calls ---

        /**
         * Fetches all workflow steps from the backend.
         * @returns {Array} An array of workflow step objects.
         */
        async function fetchStepsFromBackend() {
            try {
                const response = await fetch(API_BASE_URL);
                if (!response.ok) {
                    const errorDetail = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(`HTTP error! Status: ${response.status}, Detail: ${errorDetail.message || 'Unknown error'}`);
                }
                const data = await response.json();
                showNotification('Workflow data loaded from backend!', 'success');
                return data;
            } catch (e) {
                console.error("Error loading workflow from backend:", e);
                showNotification('Failed to load workflow data! Check console for details.', 'error');
                return []; // Return empty array on error
            }
        }

        /**
         * Saves (creates or updates) a single workflow step to the backend.
         * @param {Object} stepData - The step object to save. If it has an 'id', it's an update; otherwise, it's a create.
         * @returns {Object|null} The saved step data with its final ID, or null on failure.
         */
        async function saveStepToBackend(stepData) {
            try {
                const method = stepData.id ? 'PUT' : 'POST'; // If ID exists, it's an update (PUT); otherwise, create (POST)
                const url = stepData.id ? `${API_BASE_URL}/${stepData.id}` : API_BASE_URL;

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(stepData),
                });

                if (!response.ok) {
                    const errorDetail = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(`HTTP error! Status: ${response.status}, Detail: ${errorDetail.message || 'Unknown error'}`);
                }

                const savedData = await response.json();
                showNotification(`Workflow step ${stepData.id ? 'updated' : 'created'} successfully!`, 'success');
                return savedData;
            } catch (e) {
                console.error("Error saving workflow to backend:", e);
                showNotification('Failed to save workflow step! Check console for details.', 'error');
                return null;
            }
        }

        /**
         * Deletes a workflow step from the backend.
         * @param {number} stepId - The ID of the step to delete.
         * @returns {boolean} True if deletion was successful, false otherwise.
         */
        async function deleteStepFromBackend(stepId) {
            try {
                const response = await fetch(`${API_BASE_URL}/${stepId}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    const errorDetail = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(`HTTP error! Status: ${response.status}, Detail: ${errorDetail.message || 'Unknown error'}`);
                }
                showNotification(`Step ${stepId} deleted successfully!`, 'success');
                return true;
            } catch (e) {
                console.error("Error deleting workflow from backend:", e);
                showNotification('Failed to delete step! Check console for details.', 'error');
                return false;
            }
        }

        // --- DOM Manipulation & Rendering ---
        const workflowCardsContainer = document.getElementById('workflowCardsContainer');
        const addStepCard = document.getElementById('addStepCard');
        const body = document.body;

        /**
         * Opens a modal for a specific step ID and populates its form.
         * @param {number} stepId - The ID of the step to open the modal for.
         */
        function openModal(stepId) {
            currentEditingStepId = stepId;
            const modal = document.getElementById(`modal${stepId}`);
            if (modal) {
                const stepData = workflowSteps.find(step => step.id === stepId);
                if (stepData) {
                    const form = modal.querySelector('.modal-form');
                    form.elements.title.value = stepData.title || '';
                    form.elements.integration.value = stepData.integration || '';
                    form.elements.description.value = stepData.description || '';
                    modal.classList.add('open');
                } else {
                    showNotification('Error: Step data not found for editing!', 'error');
                }
            } else {
                showNotification('Error: Modal not found for this step!', 'error');
            }
        }

        /**
         * Closes a modal for a specific step ID.
         * @param {number} stepId - The ID of the step whose modal should be closed.
         */
        function closeModal(stepId) {
            const modal = document.getElementById(`modal${stepId}`);
            if (modal) {
                modal.classList.remove('open');
                currentEditingStepId = null; // Clear tracking
            }
        }

        // Centralized event listener for all dynamic interactions (card clicks, modal buttons)
        document.addEventListener('click', async (event) => {
            // Close modal button or clicking on modal overlay
            if (event.target.classList.contains('close-modal') ||
               (event.target.classList.contains('modal') && event.target.classList.contains('open'))) {
                const modal = event.target.closest('.modal');
                if (modal) {
                    const stepId = parseInt(modal.id.replace('modal', ''));
                    closeModal(stepId);
                }
            }
            // Delete Step button on card
            else if (event.target.classList.contains('delete-step-btn')) {
                const stepId = parseInt(event.target.dataset.stepId);
                if (confirm('Are you sure you want to delete this step? This cannot be undone.')) {
                    await deleteStep(stepId);
                }
            }
            // Delete Step button inside modal
            else if (event.target.classList.contains('delete-step-btn-modal')) {
                const stepId = parseInt(event.target.dataset.stepId);
                if (confirm('Are you sure you want to delete this step? This cannot be undone.')) {
                     await deleteStep(stepId);
                }
            }
            // "Define Step" button on card (opens modal)
            else if (event.target.tagName === 'BUTTON' && event.target.textContent.includes('Define Step')) {
                const card = event.target.closest('.bg-white');
                const stepId = parseInt(card.id.replace('card', ''));
                openModal(stepId);
            }
        });

        // Handle form submission (Save button inside modal)
        document.addEventListener('submit', async (event) => {
            if (event.target.classList.contains('modal-form')) {
                event.preventDefault(); // Prevent default browser form submission
                const form = event.target;
                const stepId = parseInt(form.dataset.stepId); // Get stepId from form's data-step-id
                await saveModalData(stepId, form);
            }
        });

        /**
         * Renders all workflow steps from the 'workflowSteps' array into the DOM.
         * This function should be called after any modification to 'workflowSteps'
         * (e.g., after loading, saving, or deleting from the backend).
         */
        function renderAllSteps() {
            // Remove all existing dynamic cards (except the static 'Add New Step' card)
            const existingCards = workflowCardsContainer.querySelectorAll('.bg-white:not(#addStepCard)');
            existingCards.forEach(card => card.remove());

            // Remove all existing modals from the body
            document.querySelectorAll('.modal').forEach(modal => {
                if (modal.id.startsWith('modal')) { // Only remove elements whose ID starts with 'modal'
                    modal.remove();
                }
            });

            // Sort steps by ID to ensure consistent order (important if backend doesn't guarantee it)
            workflowSteps.sort((a, b) => a.id - b.id);

            workflowSteps.forEach(step => {
                // Create Card Element
                const card = document.createElement('div');
                card.id = `card${step.id}`;
                let buttonBgColor;
                if (step.id === 1) buttonBgColor = 'bg-blue-500';
                else if (step.id === 2) buttonBgColor = 'bg-green-500';
                else buttonBgColor = 'bg-purple-500';

                card.className = `bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-shadow duration-300`;
                card.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Step ${step.id}: ${step.title || 'Untitled'}</h3>
                    <p class="text-gray-600">${step.description ? (step.description.length > 100 ? step.description.substring(0, 100) + '...' : step.description) : 'Click to define details.'}</p>
                    <button class="mt-4 ${buttonBgColor} hover:opacity-90 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-${buttonBgColor.split('-')[1]}-500 focus:ring-opacity-50">Define Step</button>
                    <button data-step-id="${step.id}" class="delete-step-btn ml-2 mt-4 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">Delete</button>
                `;
                workflowCardsContainer.insertBefore(card, addStepCard);

                // Create Modal Element
                const modal = document.createElement('div');
                modal.id = `modal${step.id}`;
                modal.className = 'modal fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">Step ${step.id} Details</h3>
                            <button class="close-modal text-gray-500 hover:text-gray-700 focus:outline-none">
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <form data-step-id="${step.id}" class="modal-form">
                            <div class="mb-4">
                                <label for="title${step.id}" class="block text-gray-700 text-sm font-bold mb-2">Title <span class="text-red-500">*</span></label>
                                <input type="text" id="title${step.id}" name="title" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., Step ${step.id} Title" required>
                            </div>
                            <div class="mb-4">
                                <label for="integration${step.id}" class="block text-gray-700 text-sm font-bold mb-2">Integration</label>
                                <input type="text" id="integration${step.id}" name="integration" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., API for Step ${step.id}">
                            </div>
                            <div class="mb-6">
                                <label for="description${step.id}" class="block text-gray-700 text-sm font-bold mb-2">Description <span class="text-red-500">*</span></label>
                                <textarea id="description${step.id}" name="description" rows="5" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Provide a detailed description of this workflow step." required></textarea>
                            </div>
                            <div class="flex justify-end mt-4">
                                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2">Save</button>
                                <button type="button" class="delete-step-btn-modal bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2" data-step-id="${step.id}">Delete Step</button>
                                <button type="button" class="close-modal bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Close</button>
                            </div>
                        </form>
                    </div>
                `;
                body.appendChild(modal);
            });
        }

        /**
         * Saves data from the modal form for a specific step to the backend.
         * This function handles both creating new steps and updating existing ones.
         * @param {number|null} stepId - The ID of the step being saved/updated. null for new steps initially.
         * @param {HTMLFormElement} form - The form element containing the input data.
         */
        async function saveModalData(stepId, form) {
            const title = form.elements.title.value.trim();
            const integration = form.elements.integration.value.trim();
            const description = form.elements.description.value.trim();

            if (!title || !description) {
                showNotification('Title and Description are required!', 'error');
                return;
            }

            let stepDataToSend = {
                title: title,
                integration: integration,
                description: description
            };

            // If stepId is already assigned (meaning it's an existing step or a newly created one on the frontend),
            // include it for the PUT request. Otherwise, it's a new POST.
            if (stepId !== null) {
                stepDataToSend.id = stepId;
            }

            const backendResponse = await saveStepToBackend(stepDataToSend);

            if (backendResponse) {
                // Find the index of the step in the local array using the ID from the backend's response
                const existingStepIndex = workflowSteps.findIndex(step => step.id === backendResponse.id);
                
                if (existingStepIndex === -1) {
                    workflowSteps.push(backendResponse); // Add new step to local array
                } else {
                    workflowSteps[existingStepIndex] = { ...workflowSteps[existingStepIndex], ...backendResponse }; // Update existing step
                }
                renderAllSteps(); // Re-render the UI to reflect changes
                closeModal(backendResponse.id); // Close the modal using the backend-assigned ID
            }
        }

        /**
         * Creates a new workflow step locally, adds it to the workflowSteps array,
         * renders the UI, and then opens its modal for the user to fill in details.
         * The actual save to backend happens when the user clicks 'Save' in the modal.
         */
        function createNewStep() {
            // Find the maximum existing ID and increment for a temporary frontend ID.
            // The backend will provide the real ID on first save (POST).
            const tempId = workflowSteps.length > 0 ? Math.max(...workflowSteps.map(step => step.id)) + 1 : 1;

            const newStepData = {
                id: tempId, // Assign a temporary frontend ID
                title: 'New Workflow Step', // Default title
                integration: '',
                description: ''
            };

            workflowSteps.push(newStepData); // Add to local array immediately
            renderAllSteps(); // Re-render to show the new card

            // Now open the modal for this new step, which initially has a temporary ID
            openModal(tempId);
        }

        /**
         * Deletes a workflow step from the backend and then updates the UI.
         * @param {number} stepId - The ID of the step to delete.
         */
        async function deleteStep(stepId) {
            const success = await deleteStepFromBackend(stepId);
            if (success) {
                // Remove the step from the local array
                workflowSteps = workflowSteps.filter(step => step.id !== stepId);
                renderAllSteps(); // Re-render to update the UI
                closeModal(stepId); // Ensure modal is closed
            }
        }

        // --- Initial Application Setup ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Load steps from the backend when the page loads
            workflowSteps = await fetchStepsFromBackend();
            renderAllSteps(); // Render the initial UI based on loaded data

            // Attach event listener to the "Add New Step" card
            addStepCard.addEventListener('click', createNewStep);

            // Sidebar toggling (retained as before)
            const sidebar = document.getElementById('sidebar');
            const openSidebarBtn = document.getElementById('openSidebar');
            const closeSidebarBtn = document.getElementById('closeSidebar');

            openSidebarBtn.addEventListener('click', () => {
                sidebar.classList.remove('sidebar-closed');
                sidebar.classList.add('sidebar-open');
            });
            closeSidebarBtn.addEventListener('click', () => {
                sidebar.classList.remove('sidebar-open');
                sidebar.classList.add('sidebar-closed');
            });

            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    sidebar.classList.remove('sidebar-closed', 'sidebar-open');
                } else {
                    sidebar.classList.add('sidebar-closed');
                }
            });
        });
    </script>
</body>
</html>
