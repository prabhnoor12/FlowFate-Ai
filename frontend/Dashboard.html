<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - FlowFate AI</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="main-container">
    <div class="sidebar" id="sidebarNav">
      <div class="sidebar-header">
        <div class="sidebar-title">FlowFate</div>
        <div class="sidebar-subtitle">AI Automation Platform</div>
      </div>
      <nav class="sidebar-nav">
        <a href="Dashboard.html" class="sidebar-link active">üè† Dashboard</a>
        <a href="integrations.html" class="sidebar-link">üîó Integrations</a>
        <a href="aiInterface.html" class="sidebar-link">ü§ñ AI Interface</a>
        <a href="Workflows.html" class="sidebar-link">üîÑ Workflows</a>
        <a href="Automations.html" class="sidebar-link">‚ö° Automations</a>
        <div class="sidebar-settings">
          <a href="userProfile.html" class="sidebar-link">‚öôÔ∏è Settings</a>
        </div>
      </nav>
    </div>
    <div class="main-content">
      <header class="dashboard-header">
        <button id="menuToggleMobile" class="mobile-menu-button" aria-label="Open sidebar">
          <svg class="icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5h14a1 1 0 100-2H3a1 1 0 100 2zm14 4H3a1 1 0 100 2h14a1 1 0 100-2zm0 6H3a1 1 0 100 2h14a1 1 0 100-2z" clip-rule="evenodd"/></svg>
        </button>
        <div class="dashboard-title" id="welcome-message">Welcome!</div>
        <a href="/userProfile.html" id="user-initial" class="user-initial">?</a>
      </header>
      <main class="dashboard-main">
        <div id="loading-spinner" class="text-center" style="padding:2rem;">
          <p>Loading Dashboard...</p>
        </div>
        <div id="error-message" class="hidden" style="background:#fee2e2;border:1px solid #f87171;color:#b91c1c;padding:1rem;border-radius:0.5rem;" role="alert">
          <strong>Error:</strong>
          <span>Could not load dashboard data. Please try again later.</span>
        </div>
        <div id="dashboard-content" class="hidden">
          <div class="dashboard-grid">
            <div class="notifications-panel dashboard-card" id="notifications-panel">
              <h3>Notifications</h3>
              <ul id="notifications-list"></ul>
            </div>
            <div class="activity-feed dashboard-card" id="activity-feed">
              <h3>Recent Activity</h3>
              <ul id="activity-list"></ul>
            </div>
            <div class="quick-links dashboard-card">
              <h3>Quick Links</h3>
              <ul>
                <li><a href="Automations.html">View All Automations</a></li>
                <li><a href="Workflows.html">Explore Workflows</a></li>
                <li><a href="integrations.html">Manage Integrations</a></li>
                <li><a href="userProfile.html">Profile Settings</a></li>
              </ul>
            </div>
            <div class="automation-tip dashboard-card" id="automation-tip"></div>
          </div>
          <div class="dashboard-grid">
            <div class="stat-card">
              <div class="stat-label">Working Automations</div>
              <div class="stat-value" id="stat-working">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Paused Automations</div>
              <div class="stat-value" id="stat-paused">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Completed Automations</div>
              <div class="stat-value" id="stat-completed">0</div>
            </div>
          </div>
          <div class="chart-section dashboard-card">
            <h2>Automations Overview</h2>
            <canvas id="automations-chart" height="100"></canvas>
          </div>
          <div class="time-tracker dashboard-card">
            <div>
              <strong>Time Spent on Dashboard:</strong> <span id="time-spent">00:00:00</span>
            </div>
            <button id="reset-timer" style="background:#2563eb;color:#fff;border:none;padding:0.5rem 1rem;border-radius:0.5rem;cursor:pointer;">Reset Timer</button>
          </div>
          <div class="footer">&copy; 2025 FlowFate AI. All rights reserved. | <a href="help.html" style="color:#2563eb;text-decoration:underline;">Documentation</a></div>
        </div>
      </main>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
      // Responsive sidebar toggle (reuse from integrations)
      function isMobile() { return window.innerWidth <= 767; }
      const menuToggleMobile = document.getElementById('menuToggleMobile');
      const sidebar = document.getElementById('sidebarNav');
      if (menuToggleMobile && sidebar) {
        menuToggleMobile.addEventListener('click', () => {
          sidebar.classList.toggle('sidebar-open');
        });
        document.addEventListener('click', (e) => {
          if (
            isMobile() &&
            sidebar.classList.contains('sidebar-open') &&
            !sidebar.contains(e.target) &&
            e.target !== menuToggleMobile &&
            !menuToggleMobile.contains(e.target)
          ) {
            sidebar.classList.remove('sidebar-open');
          }
        });
        window.addEventListener('resize', () => {
          if (!isMobile()) {
            sidebar.classList.remove('sidebar-open');
          }
        });
      }

      // Dashboard logic
      const loadingSpinner = document.getElementById('loading-spinner');
      const errorMessage = document.getElementById('error-message');
      const dashboardContent = document.getElementById('dashboard-content');
      const welcomeMessage = document.getElementById('welcome-message');
      const userInitial = document.getElementById('user-initial');
      const statWorking = document.getElementById('stat-working');
      const statPaused = document.getElementById('stat-paused');
      const statCompleted = document.getElementById('stat-completed');
      const automationTip = document.getElementById('automation-tip');
      const notificationsList = document.getElementById('notifications-list');
      const activityList = document.getElementById('activity-list');
      // Dynamic backend URL
      const BACKEND_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:4000' : 'https://flowfate-ai.onrender.com';
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }
      // Helper to show/hide
      function show(el) { if (el) el.classList.remove('hidden'); }
      function hide(el) { if (el) el.classList.add('hidden'); }
      try {
        const res = await fetch(`${BACKEND_BASE_URL}/api/dashboard`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const jsonResponse = await res.json();
        if (!res.ok) {
          hide(loadingSpinner);
          show(errorMessage);
          errorMessage.querySelector('span').textContent = jsonResponse?.error?.message || 'Could not load dashboard data. Please try again later.';
          return;
        }
        const data = jsonResponse.data;
        hide(loadingSpinner);
        show(dashboardContent);
        // User info
        if (data?.user?.name) {
          welcomeMessage.textContent = `Welcome, ${data.user.name}!`;
          userInitial.textContent = data.user.name.charAt(0).toUpperCase();
        } else if (data?.user?.email) {
          welcomeMessage.textContent = 'Welcome!';
          userInitial.textContent = data.user.email.charAt(0).toUpperCase();
        } else {
          welcomeMessage.textContent = 'Welcome!';
          userInitial.textContent = '?';
        }
        // Stats
        // Use workflow stats for automations
        const workflowStats = data?.stats?.workflows || {};
        statWorking.textContent = workflowStats.running ?? 0;
        statPaused.textContent = workflowStats.paused ?? 0;
        statCompleted.textContent = workflowStats.completed ?? 0;
        // Chart
        const chartSection = document.querySelector('.chart-section');
        const chartCanvas = document.getElementById('automations-chart');
        if (chartCanvas && (workflowStats.running || workflowStats.paused || workflowStats.completed)) {
          const ctx = chartCanvas.getContext('2d');
          new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: ['Working', 'Paused', 'Completed'],
              datasets: [{
                data: [workflowStats.running || 0, workflowStats.paused || 0, workflowStats.completed || 0],
                backgroundColor: ['#2563eb', '#fbbf24', '#10b981'],
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { position: 'bottom' } }
            }
          });
        } else if (chartSection) {
          chartSection.innerHTML += '<div style="text-align:center;color:#888;margin-top:1rem;">No automation data to display.</div>';
        }
        // Automation tip
        automationTip.textContent = data?.tip || '';
        // Notifications
        notificationsList.innerHTML = '';
        if (Array.isArray(data?.notifications) && data.notifications.length > 0) {
          data.notifications.forEach(n => {
            const li = document.createElement('li');
            li.textContent = `${n.message} (${n.time || ''})`;
            notificationsList.appendChild(li);
          });
        } else {
          notificationsList.innerHTML = '<li style="color:#888;">No notifications to display.</li>';
        }
        // Activity feed
        activityList.innerHTML = '';
        if (Array.isArray(data?.activity) && data.activity.length > 0) {
          data.activity.forEach(a => {
            const li = document.createElement('li');
            li.textContent = `${a.action}: ${a.detail} (${a.time || ''})`;
            activityList.appendChild(li);
          });
        } else {
          activityList.innerHTML = '<li style="color:#888;">No recent activity to display.</li>';
        }
      } catch (error) {
        hide(loadingSpinner);
        show(errorMessage);
        errorMessage.querySelector('span').textContent = error?.message || 'Could not load dashboard data. Please try again later.';
      }

      // Time tracker
      let timer = 0;
      let timerInterval = null;
      const timeSpent = document.getElementById('time-spent');
      const resetBtn = document.getElementById('reset-timer');
      function updateTimer() {
        const h = String(Math.floor(timer / 3600)).padStart(2, '0');
        const m = String(Math.floor((timer % 3600) / 60)).padStart(2, '0');
        const s = String(timer % 60).padStart(2, '0');
        timeSpent.textContent = `${h}:${m}:${s}`;
      }
      function startTimer() {
        timerInterval = setInterval(() => {
          timer++;
          updateTimer();
        }, 1000);
      }
      function resetTimer() {
        timer = 0;
        updateTimer();
      }
      resetBtn.addEventListener('click', resetTimer);
      updateTimer();
      startTimer();
    });
  </script>
</body>
</html>
